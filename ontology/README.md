# Ontology Directory

This directory contains ontology files used for predicate canonicalization and filtering during GraphRAG extraction.

## Files

### `canonical_predicates.yml`

Contains canonical predicates, symmetric predicates, and type constraints. This file defines:

**Structure:**

- `canonical_predicates`: List of high-signal predicates (20-80 typically)
- `symmetric_predicates`: Predicates that are bidirectional
- `predicate_type_constraints`: Allowed (src_type, tgt_type) pairs per predicate
- `stats`: Frequency and confidence statistics per predicate

### `entity_types.yml`

Contains observed entity types and merge suggestions. Generated by `scripts/derive_ontology.py`.

**Structure:**

- `observed_types`: All entity types found in your data with counts
- `canonical_types`: Your canonical type set
- `merge_suggestions`: Non-canonical types with suggested canonical mappings
- `samples`: Example entity names for each type

### `predicate_map.yml`

Contains canonicalization mapping from predicate variants to canonical forms. Generated by `scripts/build_predicate_map.py`.

**Structure:**

- `auto_mapped`: Predicates automatically mapped to canonical forms
- `review_list`: Predicates needing manual review and mapping
- `stats`: Summary statistics

## Usage

### Step 1: Derive Ontology

```bash
# Use default database and collection
python scripts/derive_ontology.py

# Or specify custom database/collection
python scripts/derive_ontology.py --db validation_db --coll video_chunks
```

**Environment Variables:**

- `MIN_REL_FREQ`: Minimum frequency for predicate (default: 15)
- `MIN_REL_DOCS`: Minimum document count (default: 8)
- `MIN_TYPE_FREQ`: Minimum frequency for entity type (default: 50)
- `MIN_REL_CONF`: Minimum confidence threshold (default: 0.6)

### Step 2: Build Predicate Map

```bash
# Use default predicates file
python scripts/build_predicate_map.py

# Or specify custom paths
python scripts/build_predicate_map.py --db validation_db --coll video_chunks --predicates-file ontology/predicates.yml
```

**Environment Variables:**

- `MIN_SIMILARITY`: Minimum Jaro-Winkler similarity (default: 0.88)
- `MIN_TYPE_COMPAT`: Minimum type-pair compatibility (default: 0.7)

## Re-running

Re-run these scripts anytime after new extraction data is added to update the ontology:

```bash
# After new extractions
python scripts/derive_ontology.py
python scripts/build_predicate_map.py
```

## Integration with Extraction

The extraction stage automatically loads and uses these ontology files:

- **During extraction**: Predicates are canonicalized using `predicate_map.yml`
- **Filtering**: Only canonical predicates from `canonical_predicates.yml` are kept
- **Type constraints**: Relationships are validated against `predicate_type_constraints`
- **Symmetric normalization**: Symmetric predicates have endpoints sorted alphabetically

**Environment Variable:**

```bash
GRAPHRAG_ONTOLOGY_DIR=ontology  # Default: "ontology"
```

If ontology files are missing, extraction will continue without filtering (backward compatible). A warning will be logged.

## Notes

- The scripts process only documents with `graphrag_extraction.status == "completed"`
- Predicates are normalized (lowercase, snake_case, lemmatized)
- Type constraints help identify which predicates are compatible
- Review the `review_list` in `predicate_map.yml` for manual mapping decisions
- Missing ontology files will cause extraction to continue without filtering (backward compatible)
